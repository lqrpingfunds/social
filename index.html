<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialHub | Connect with Friends</title>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --bg-card: #1a1a1a;
            --border-color: #333333;
            --border-light: #444444;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --accent: #ffffff;
            --accent-hover: #f0f0f0;
            --success: #00ff00;
            --danger: #ff3333;
            --warning: #ffaa00;
            --online: #00ff00;
            --offline: #ff3333;
            --away: #ffaa00;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --radius: 12px;
            --radius-sm: 6px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'SF Mono', 'Cascadia Code', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Header */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            height: 72px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: var(--transition);
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--text-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: var(--bg-primary);
        }

        .nav-links {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: var(--transition);
            position: relative;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            color: var(--text-primary);
        }

        .nav-link.active {
            color: var(--text-primary);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--text-primary);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-badge {
            position: relative;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .username-display {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            margin-top: 72px;
            min-height: calc(100vh - 72px);
            padding: 32px;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Profile Header */
        .profile-header {
            position: relative;
            margin-bottom: 32px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .profile-banner {
            height: 280px;
            width: 100%;
            background: linear-gradient(135deg, #222222, #000000);
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.9));
        }

        .banner-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
        }

        .profile-main {
            padding: 32px;
            position: relative;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 32px;
            align-items: start;
        }

        .avatar-container {
            position: relative;
            margin-top: -100px;
        }

        .profile-avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 6px solid var(--bg-secondary);
            background: var(--bg-card);
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .profile-avatar:hover::after {
            content: 'üì∑ Change';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            border-radius: 50%;
            backdrop-filter: blur(4px);
        }

        .avatar-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
            background: var(--online);
        }

        .profile-info {
            padding-top: 20px;
        }

        .profile-name {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .profile-username {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            font-weight: 400;
        }

        .profile-bio {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
            max-width: 600px;
        }

        .profile-stats {
            display: flex;
            gap: 40px;
            margin-top: 24px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: var(--transition);
            padding: 12px;
            border-radius: var(--radius-sm);
        }

        .stat:hover {
            background: var(--bg-tertiary);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 4px;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 200px;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            margin-top: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .card:hover {
            border-color: var(--border-light);
            transform: translateY(-4px);
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-body {
            padding: 24px;
        }

        /* Friends Grid */
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .friend-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .friend-card:hover {
            border-color: var(--border-light);
            transform: translateY(-8px);
            background: var(--bg-tertiary);
        }

        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            background-size: cover;
            margin-bottom: 16px;
            border: 3px solid var(--border-color);
            position: relative;
        }

        .friend-status {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
        }

        .friend-status.online { background: var(--online); }
        .friend-status.offline { background: var(--offline); }
        .friend-status.away { background: var(--away); }

        .friend-name {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .friend-username {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .friend-actions {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        /* Messages */
        .messages-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 600px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .conversations-sidebar {
            border-right: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .conversation:hover {
            background: var(--bg-tertiary);
        }

        .conversation.active {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent);
        }

        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            background-size: cover;
            position: relative;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
        }

        .chat-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-username {
            font-weight: 700;
            font-size: 18px;
        }

        .chat-status {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online);
        }

        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--bg-secondary);
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 75%;
        }

        .message.received {
            align-self: flex-start;
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            background-size: cover;
            flex-shrink: 0;
        }

        .message-content {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .message.sent .message-content {
            background: var(--bg-primary);
            border-color: var(--border-light);
        }

        .message-text {
            color: var(--text-primary);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: right;
        }

        .chat-input-area {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .message-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 60px;
            max-height: 200px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: var(--font-main);
            font-size: 15px;
            resize: none;
            transition: var(--transition);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--border-light);
            background: var(--bg-tertiary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-family: var(--font-main);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
            border-color: var(--success);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 8px;
            width: 40px;
            height: 40px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-main);
            font-size: 15px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--border-light);
            background: var(--bg-tertiary);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* File Upload */
        .file-upload-container {
            position: relative;
            margin-bottom: 24px;
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-secondary);
        }

        .file-upload-area:hover {
            border-color: var(--border-light);
            background: var(--bg-tertiary);
        }

        .file-upload-area.drag-over {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .file-upload-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-input {
            display: none;
        }

        .file-preview {
            margin-top: 24px;
            display: none;
        }

        .preview-container {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            background: var(--bg-secondary);
        }

        .preview-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(20px);
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
        }

        .modal-large {
            max-width: 800px;
        }

        .modal-header {
            padding: 32px 32px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 32px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-tertiary);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 3000;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
            max-width: 400px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-success .notification-icon {
            background: rgba(0, 255, 0, 0.1);
            color: var(--success);
        }

        .notification-error .notification-icon {
            background: rgba(255, 51, 51, 0.1);
            color: var(--danger);
        }

        .notification-info .notification-icon {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online .status-dot { background: var(--online); }
        .status-offline .status-dot { background: var(--offline); }
        .status-away .status-dot { background: var(--away); }

        /* Empty States */
        .empty-state {
            padding: 64px 32px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .empty-description {
            max-width: 400px;
            margin: 0 auto 32px;
            line-height: 1.6;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mt-4 { margin-top: 32px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mb-4 { margin-bottom: 32px; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .w-100 { width: 100%; }
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .d-block { display: block; }
        .d-inline { display: inline; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .gap-3 { gap: 24px; }
        .gap-4 { gap: 32px; }
        .flex-1 { flex: 1; }
        .flex-wrap { flex-wrap: wrap; }
        .cursor-pointer { cursor: pointer; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .messages-container {
                grid-template-columns: 1fr;
                height: 500px;
            }
            
            .conversations-sidebar {
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        @media (max-width: 768px) {
            .site-header {
                padding: 0 16px;
                height: 60px;
            }
            
            .main-content {
                margin-top: 60px;
                padding: 16px;
            }
            
            .nav-links {
                display: none;
            }
            
            .profile-main {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 24px;
            }
            
            .avatar-container {
                margin-top: -80px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .profile-avatar {
                width: 140px;
                height: 140px;
            }
            
            .profile-info {
                padding-top: 0;
            }
            
            .profile-stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .profile-actions {
                width: 100%;
            }
            
            .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Notification System -->
    <div id="notificationContainer"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay" style="display: flex;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Welcome to SocialHub</div>
            </div>
            <div class="modal-body">
                <div class="auth-tabs" style="display: flex; margin-bottom: 32px; border-bottom: 1px solid var(--border-color);">
                    <button class="btn btn-small" id="loginTab" style="flex: 1; border: none; border-bottom: 2px solid var(--text-primary); border-radius: 0; padding: 16px; background: none; color: var(--text-primary); font-weight: 700;">LOGIN</button>
                    <button class="btn btn-small" id="registerTab" style="flex: 1; border: none; border-radius: 0; padding: 16px; background: none; color: var(--text-secondary); font-weight: 600;">REGISTER</button>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">USERNAME</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PASSWORD</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                        <span>LOGIN</span>
                        <span class="loading d-none"></span>
                    </button>
                </form>
                
                <form id="registerForm" class="d-none">
                    <div class="form-group">
                        <label class="form-label">USERNAME</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DISPLAY NAME</label>
                        <input type="text" id="registerDisplayName" class="form-input" placeholder="Your display name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">BIO (OPTIONAL)</label>
                        <textarea id="registerBio" class="form-input form-textarea" placeholder="Tell us about yourself"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PASSWORD</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="Create a strong password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CONFIRM PASSWORD</label>
                        <input type="password" id="registerConfirmPassword" class="form-input" placeholder="Confirm your password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AVATAR (OPTIONAL)</label>
                        <div class="file-upload-container">
                            <div class="file-upload-area" id="registerAvatarUpload">
                                <div class="file-upload-icon">üìÅ</div>
                                <div class="file-upload-text">Click to upload avatar</div>
                                <div class="file-upload-hint">PNG, JPG, GIF up to 5MB</div>
                                <input type="file" class="file-input" id="registerAvatarFile" accept="image/*">
                            </div>
                            <div class="file-preview" id="registerAvatarPreview">
                                <div class="preview-container">
                                    <img class="preview-image" id="registerAvatarPreviewImg">
                                    <div class="preview-actions">
                                        <button type="button" class="btn btn-danger btn-icon" onclick="clearPreview('registerAvatar')">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">BANNER (OPTIONAL)</label>
                        <div class="file-upload-container">
                            <div class="file-upload-area" id="registerBannerUpload">
                                <div class="file-upload-icon">üìÅ</div>
                                <div class="file-upload-text">Click to upload banner</div>
                                <div class="file-upload-hint">PNG, JPG up to 10MB</div>
                                <input type="file" class="file-input" id="registerBannerFile" accept="image/*">
                            </div>
                            <div class="file-preview" id="registerBannerPreview">
                                <div class="preview-container">
                                    <img class="preview-image" id="registerBannerPreviewImg">
                                    <div class="preview-actions">
                                        <button type="button" class="btn btn-danger btn-icon" onclick="clearPreview('registerBanner')">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="registerBtn">
                        <span>CREATE ACCOUNT</span>
                        <span class="loading d-none"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="d-none">
        <!-- Header -->
        <header class="site-header">
            <a href="#" class="logo">
                <span class="logo-icon">S</span>
                SocialHub
            </a>
            <nav class="nav-links">
                <a href="#" class="nav-link active" data-page="home">
                    <i class="fas fa-home"></i>
                    HOME
                </a>
                <a href="#" class="nav-link" data-page="friends">
                    <i class="fas fa-users"></i>
                    FRIENDS
                </a>
                <a href="#" class="nav-link" data-page="messages">
                    <i class="fas fa-comments"></i>
                    MESSAGES
                </a>
                <a href="#" class="nav-link" data-page="search">
                    <i class="fas fa-search"></i>
                    SEARCH
                </a>
            </nav>
            <div class="user-section">
                <button class="btn btn-icon notification-badge" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count d-none">0</span>
                </button>
                <span class="username-display" id="headerUsername">
                    <i class="fas fa-user"></i>
                    @username
                </span>
                <button class="btn btn-small" id="logoutBtn">LOGOUT</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-container">
                <!-- Home Page -->
                <div id="homePage" class="page">
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <div class="profile-banner" id="userBanner">
                            <div class="banner-overlay"></div>
                            <div class="banner-actions">
                                <button class="btn btn-small" onclick="openUploadModal('banner')">
                                    <i class="fas fa-camera"></i>
                                    Change Banner
                                </button>
                            </div>
                        </div>
                        <div class="profile-main">
                            <div class="avatar-container">
                                <div class="profile-avatar" id="userAvatar" onclick="openUploadModal('avatar')"></div>
                                <div class="avatar-status" id="userStatus"></div>
                                <button class="btn btn-small mt-2" onclick="openUploadModal('avatar')">
                                    <i class="fas fa-edit"></i>
                                    Change Avatar
                                </button>
                            </div>
                            <div class="profile-info">
                                <h1 class="profile-name" id="userDisplayName">Loading...</h1>
                                <div class="profile-username" id="userUsername">@loading</div>
                                <div class="profile-bio" id="userBio">No bio yet</div>
                                <div class="profile-stats">
                                    <div class="stat" onclick="showPage('friends')">
                                        <span class="stat-value" id="statFriends">0</span>
                                        <span class="stat-label">FRIENDS</span>
                                    </div>
                                    <div class="stat" onclick="showPage('messages')">
                                        <span class="stat-value" id="statMessages">0</span>
                                        <span class="stat-label">MESSAGES</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-value" id="statOnline">0</span>
                                        <span class="stat-label">ONLINE</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-value" id="statRequests">0</span>
                                        <span class="stat-label">REQUESTS</span>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button class="btn" onclick="showPage('friends')">
                                    <i class="fas fa-user-plus"></i>
                                    Add Friend
                                </button>
                                <button class="btn" onclick="editProfile()">
                                    <i class="fas fa-edit"></i>
                                    Edit Profile
                                </button>
                                <button class="btn" onclick="changeStatus()">
                                    <i class="fas fa-circle"></i>
                                    Change Status
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="content-grid">
                        <div class="main-column">
                            <!-- Recent Activity -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-history"></i>
                                        RECENT ACTIVITY
                                    </div>
                                    <button class="btn btn-small" onclick="loadActivity()">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="activityList">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìù</div>
                                            <div class="empty-title">No Activity Yet</div>
                                            <div class="empty-description">Your recent activity will appear here</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Online Friends -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-wifi"></i>
                                        ONLINE NOW
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="friends-grid" id="onlineFriendsGrid"></div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-column">
                            <!-- Friend Requests -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-user-clock"></i>
                                        FRIEND REQUESTS
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="friendRequestsList"></div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-bolt"></i>
                                        QUICK ACTIONS
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-small" onclick="showPage('search')">
                                            <i class="fas fa-search"></i>
                                            Search Users
                                        </button>
                                        <button class="btn btn-small" onclick="showPage('messages')">
                                            <i class="fas fa-comment"></i>
                                            New Message
                                        </button>
                                        <button class="btn btn-small" onclick="editProfile()">
                                            <i class="fas fa-cog"></i>
                                            Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Page -->
                <div id="friendsPage" class="page d-none">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                MY FRIENDS
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-small" onclick="loadFriends()">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                                <button class="btn btn-primary btn-small" onclick="showAddFriendModal()">
                                    <i class="fas fa-user-plus"></i>
                                    Add Friend
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="friends-grid" id="friendsGrid"></div>
                        </div>
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messagesPage" class="page d-none">
                    <div class="messages-container">
                        <div class="conversations-sidebar">
                            <div class="conversations-header">
                                <div class="card-title">
                                    <i class="fas fa-comments"></i>
                                    CONVERSATIONS
                                </div>
                            </div>
                            <div class="conversations-list" id="conversationsList"></div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header">
                                <div class="chat-user-info" id="chatHeaderInfo">
                                    <div class="empty-state" style="padding: 0;">
                                        <div class="empty-icon">üí¨</div>
                                        <div class="empty-title">Select a conversation</div>
                                        <div class="empty-description">Choose a friend to start messaging</div>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area d-none" id="chatInputArea">
                                <div class="message-input-container">
                                    <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="3"></textarea>
                                    <button class="btn btn-primary btn-icon" id="sendMessageBtn" onclick="sendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Page -->
                <div id="searchPage" class="page d-none">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-search"></i>
                                SEARCH USERS
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <input type="text" id="searchInput" class="form-input" placeholder="Search by username or display name..." oninput="searchUsers(this.value)">
                            </div>
                            <div id="searchResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal-overlay d-none">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Edit Profile</div>
                <button class="modal-close" onclick="closeModal('editProfileModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" id="editDisplayName" class="form-input" placeholder="Your display name">
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="editUsername" class="form-input" placeholder="Your username" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea id="editBio" class="form-input form-textarea" placeholder="Tell others about yourself" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="editStatus" class="form-input">
                        <option value="online">üü¢ Online</option>
                        <option value="away">üü° Away</option>
                        <option value="offline">üî¥ Offline</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Change Avatar</label>
                    <div class="file-upload-container">
                        <div class="file-upload-area" id="editAvatarUpload">
                            <div class="file-upload-icon">üìÅ</div>
                            <div class="file-upload-text">Click to upload new avatar</div>
                            <div class="file-upload-hint">PNG, JPG, GIF up to 5MB</div>
                            <input type="file" class="file-input" id="editAvatarFile" accept="image/*">
                        </div>
                        <div class="file-preview" id="editAvatarPreview">
                            <div class="preview-container">
                                <img class="preview-image" id="editAvatarPreviewImg">
                                <div class="preview-actions">
                                    <button type="button" class="btn btn-danger btn-icon" onclick="clearPreview('editAvatar')">√ó</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Change Banner</label>
                    <div class="file-upload-container">
                        <div class="file-upload-area" id="editBannerUpload">
                            <div class="file-upload-icon">üìÅ</div>
                            <div class="file-upload-text">Click to upload new banner</div>
                            <div class="file-upload-hint">PNG, JPG up to 10MB</div>
                            <input type="file" class="file-input" id="editBannerFile" accept="image/*">
                        </div>
                        <div class="file-preview" id="editBannerPreview">
                            <div class="preview-container">
                                <img class="preview-image" id="editBannerPreviewImg">
                                <div class="preview-actions">
                                    <button type="button" class="btn btn-danger btn-icon" onclick="clearPreview('editBanner')">√ó</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editProfileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="addFriendModal" class="modal-overlay d-none">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Friend</div>
                <button class="modal-close" onclick="closeModal('addFriendModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Enter Username</label>
                    <input type="text" id="addFriendInput" class="form-input" placeholder="Exact username (case insensitive)">
                </div>
                <div class="form-group">
                    <label class="form-label">Search Results</label>
                    <div id="friendSearchResults" class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Search for users</div>
                        <div class="empty-description">Enter a username above to search</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addFriendModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sendFriendRequestFromModal()" id="sendRequestBtn" disabled>Send Request</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay d-none">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="uploadModalTitle">Upload Image</div>
                <button class="modal-close" onclick="closeModal('uploadModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="file-upload-container">
                    <div class="file-upload-area" id="modalUploadArea">
                        <div class="file-upload-icon">üìÅ</div>
                        <div class="file-upload-text">Drag & drop or click to upload</div>
                        <div class="file-upload-hint" id="modalUploadHint">PNG, JPG, GIF up to 5MB</div>
                        <input type="file" class="file-input" id="modalFileInput" accept="image/*">
                    </div>
                    <div class="file-preview" id="modalPreview">
                        <div class="preview-container">
                            <img class="preview-image" id="modalPreviewImg">
                            <div class="preview-actions">
                                <button type="button" class="btn btn-danger btn-icon" onclick="clearPreview('modal')">√ó</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('uploadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUploadedImage()" id="saveUploadBtn" disabled>Use This Image</button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal-overlay d-none">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Notifications</div>
                <button class="modal-close" onclick="closeModal('notificationsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="notificationsList"></div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="modal-overlay d-none">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Change Status</div>
                <button class="modal-close" onclick="closeModal('statusModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="d-flex gap-3 mb-3">
                        <div class="status-option" onclick="setStatus('online')">
                            <div class="status-dot" style="background: var(--online);"></div>
                            <span>Online</span>
                        </div>
                        <div class="status-option" onclick="setStatus('away')">
                            <div class="status-dot" style="background: var(--away);"></div>
                            <span>Away</span>
                        </div>
                        <div class="status-option" onclick="setStatus('offline')">
                            <div class="status-dot" style="background: var(--offline);"></div>
                            <span>Offline</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        const STORAGE = {
            USERS: 'socialhub_users_v3',
            CURRENT: 'socialhub_current_v3',
            FRIENDS: 'socialhub_friends_v3',
            REQUESTS: 'socialhub_requests_v3',
            MESSAGES: 'socialhub_messages_v3',
            NOTIFICATIONS: 'socialhub_notifications_v3'
        };

        let currentUser = null;
        let allUsers = {};
        let friends = {};
        let friendRequests = {};
        let messages = {};
        let notifications = {};
        let currentChat = null;
        let currentUploadType = null;
        let searchTimeout = null;

        // ==================== NOTIFICATION SYSTEM ====================
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const id = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    ${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification('${id}')">√ó</button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(id);
                }, duration);
            }
            
            updateNotificationBadge();
            return id;
        }

        function closeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        function addNotification(type, title, message) {
            if (!notifications[currentUser.username]) {
                notifications[currentUser.username] = [];
            }
            
            const notification = {
                id: Date.now(),
                type: type,
                title: title,
                message: message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications[currentUser.username].unshift(notification);
            saveData();
            updateNotificationBadge();
            
            // Show toast notification if not on notifications page
            if (!document.getElementById('notificationsModal').classList.contains('d-none')) {
                loadNotifications();
            }
        }

        function updateNotificationBadge() {
            const userNotifications = notifications[currentUser.username] || [];
            const unreadCount = userNotifications.filter(n => !n.read).length;
            const badge = document.querySelector('.notification-count');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }

        function loadNotifications() {
            const container = document.getElementById('notificationsList');
            const userNotifications = notifications[currentUser.username] || [];
            
            if (userNotifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîî</div>
                        <div class="empty-title">No Notifications</div>
                        <div class="empty-description">You're all caught up!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userNotifications.forEach(notification => {
                const timeAgo = getTimeAgo(notification.timestamp);
                html += `
                    <div class="conversation ${notification.read ? '' : 'unread'}" onclick="markNotificationAsRead(${notification.id})">
                        <div class="conversation-avatar" style="background: ${notification.type === 'success' ? 'var(--success)' : notification.type === 'error' ? 'var(--danger)' : 'var(--bg-tertiary)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${notification.type === 'success' ? '‚úì' : notification.type === 'error' ? '‚úó' : '‚Ñπ'}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${notification.title}</div>
                            <div class="conversation-preview">${notification.message}</div>
                            <div class="conversation-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function markNotificationAsRead(id) {
            const userNotifications = notifications[currentUser.username] || [];
            const notification = userNotifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveData();
                updateNotificationBadge();
                loadNotifications();
            }
        }

        function markAllNotificationsAsRead() {
            const userNotifications = notifications[currentUser.username] || [];
            userNotifications.forEach(n => n.read = true);
            saveData();
            updateNotificationBadge();
            loadNotifications();
        }

        // ==================== DATA MANAGEMENT ====================
        function loadData() {
            try {
                allUsers = JSON.parse(localStorage.getItem(STORAGE.USERS) || '{}');
                friends = JSON.parse(localStorage.getItem(STORAGE.FRIENDS) || '{}');
                friendRequests = JSON.parse(localStorage.getItem(STORAGE.REQUESTS) || '{}');
                messages = JSON.parse(localStorage.getItem(STORAGE.MESSAGES) || '{}');
                notifications = JSON.parse(localStorage.getItem(STORAGE.NOTIFICATIONS) || '{}');
            } catch (e) {
                console.error('Error loading data:', e);
                // Initialize empty data if corrupted
                allUsers = {};
                friends = {};
                friendRequests = {};
                messages = {};
                notifications = {};
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE.USERS, JSON.stringify(allUsers));
                localStorage.setItem(STORAGE.FRIENDS, JSON.stringify(friends));
                localStorage.setItem(STORAGE.REQUESTS, JSON.stringify(friendRequests));
                localStorage.setItem(STORAGE.MESSAGES, JSON.stringify(messages));
                localStorage.setItem(STORAGE.NOTIFICATIONS, JSON.stringify(notifications));
            } catch (e) {
                console.error('Error saving data:', e);
                showNotification('error', 'Storage Error', 'Could not save data to browser storage');
            }
        }

        // ==================== AUTHENTICATION ====================
        function setupAuth() {
            // Tab switching
            document.getElementById('loginTab').onclick = () => switchAuthTab('login');
            document.getElementById('registerTab').onclick = () => switchAuthTab('register');
            
            // Form submissions
            document.getElementById('loginForm').onsubmit = handleLogin;
            document.getElementById('registerForm').onsubmit = handleRegister;
            
            // File upload handlers
            setupFileUpload('registerAvatarUpload', 'registerAvatarFile', 'registerAvatarPreview', 'registerAvatarPreviewImg');
            setupFileUpload('registerBannerUpload', 'registerBannerFile', 'registerBannerPreview', 'registerBannerPreviewImg');
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.style.color = 'var(--text-primary)';
                loginTab.style.borderBottom = '2px solid var(--text-primary)';
                loginTab.style.fontWeight = '700';
                registerTab.style.color = 'var(--text-secondary)';
                registerTab.style.borderBottom = 'none';
                registerTab.style.fontWeight = '600';
                loginForm.classList.remove('d-none');
                registerForm.classList.add('d-none');
            } else {
                registerTab.style.color = 'var(--text-primary)';
                registerTab.style.borderBottom = '2px solid var(--text-primary)';
                registerTab.style.fontWeight = '700';
                loginTab.style.color = 'var(--text-secondary)';
                loginTab.style.borderBottom = 'none';
                loginTab.style.fontWeight = '600';
                registerForm.classList.remove('d-none');
                loginForm.classList.add('d-none');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('error', 'Error', 'Please enter username and password');
                return;
            }
            
            const user = allUsers[username];
            if (!user || user.password !== password) {
                showNotification('error', 'Error', 'Invalid username or password');
                return;
            }
            
            showLoading('loginBtn');
            setTimeout(() => {
                loginUser(user);
                hideLoading('loginBtn');
            }, 1000);
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim().toLowerCase();
            const displayName = document.getElementById('registerDisplayName').value.trim();
            const bio = document.getElementById('registerBio').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            // Validation
            if (!username || !displayName || !password) {
                showNotification('error', 'Error', 'Please fill in all required fields');
                return;
            }
            
            if (username.length < 3) {
                showNotification('error', 'Error', 'Username must be at least 3 characters');
                return;
            }
            
            if (password.length < 6) {
                showNotification('error', 'Error', 'Password must be at least 6 characters');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('error', 'Error', 'Passwords do not match');
                return;
            }
            
            if (allUsers[username]) {
                showNotification('error', 'Error', 'Username already taken');
                return;
            }
            
            showLoading('registerBtn');
            
            // Process avatar upload
            const avatarFile = document.getElementById('registerAvatarFile').files[0];
            const bannerFile = document.getElementById('registerBannerFile').files[0];
            
            const newUser = {
                username: username,
                displayName: displayName,
                bio: bio,
                password: password,
                avatar: 'https://api.dicebear.com/9.x/avataaars/svg?seed=' + username + '&backgroundColor=000000',
                banner: '',
                status: 'online',
                joined: new Date().toISOString(),
                lastSeen: new Date().toISOString()
            };
            
            // Process avatar
            if (avatarFile) {
                processImageUpload(avatarFile, (avatarData) => {
                    newUser.avatar = avatarData;
                    // Process banner
                    if (bannerFile) {
                        processImageUpload(bannerFile, (bannerData) => {
                            newUser.banner = bannerData;
                            completeRegistration(newUser);
                        });
                    } else {
                        completeRegistration(newUser);
                    }
                });
            } else if (bannerFile) {
                processImageUpload(bannerFile, (bannerData) => {
                    newUser.banner = bannerData;
                    completeRegistration(newUser);
                });
            } else {
                completeRegistration(newUser);
            }
        }

        function completeRegistration(user) {
            allUsers[user.username] = user;
            friends[user.username] = [];
            friendRequests[user.username] = [];
            notifications[user.username] = [];
            
            saveData();
            
            setTimeout(() => {
                loginUser(user);
                hideLoading('registerBtn');
                showNotification('success', 'Welcome!', 'Account created successfully');
            }, 1000);
        }

        function loginUser(user) {
            currentUser = user;
            currentUser.status = 'online';
            currentUser.lastSeen = new Date().toISOString();
            allUsers[user.username] = currentUser;
            
            localStorage.setItem(STORAGE.CURRENT, user.username);
            saveData();
            
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('mainApp').classList.remove('d-none');
            
            updateUI();
            showNotification('success', 'Welcome back!', `Logged in as ${user.displayName}`);
        }

        // ==================== FILE UPLOAD SYSTEM ====================
        function setupFileUpload(uploadAreaId, fileInputId, previewId, previewImgId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const preview = document.getElementById(previewId);
            const previewImg = document.getElementById(previewImgId);
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(fileInput, preview, previewImg);
                }
            });
            
            fileInput.addEventListener('change', () => {
                handleFileUpload(fileInput, preview, previewImg);
            });
        }

        function handleFileUpload(fileInput, preview, previewImg) {
            const file = fileInput.files[0];
            if (!file) return;
            
            // Check file size (5MB for avatars, 10MB for banners)
            const maxSize = fileInput.id.includes('banner') ? 10 * 1024 * 1024 : 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('error', 'File too large', `Maximum size is ${maxSize/(1024*1024)}MB`);
                fileInput.value = '';
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'Invalid file', 'Please upload an image file');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                
                // Enable save button in upload modal
                if (fileInput.id === 'modalFileInput') {
                    document.getElementById('saveUploadBtn').disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }

        function clearPreview(type) {
            let fileInput, preview, previewImg;
            
            switch(type) {
                case 'registerAvatar':
                    fileInput = document.getElementById('registerAvatarFile');
                    preview = document.getElementById('registerAvatarPreview');
                    previewImg = document.getElementById('registerAvatarPreviewImg');
                    break;
                case 'registerBanner':
                    fileInput = document.getElementById('registerBannerFile');
                    preview = document.getElementById('registerBannerPreview');
                    previewImg = document.getElementById('registerBannerPreviewImg');
                    break;
                case 'editAvatar':
                    fileInput = document.getElementById('editAvatarFile');
                    preview = document.getElementById('editAvatarPreview');
                    previewImg = document.getElementById('editAvatarPreviewImg');
                    break;
                case 'editBanner':
                    fileInput = document.getElementById('editBannerFile');
                    preview = document.getElementById('editBannerPreview');
                    previewImg = document.getElementById('editBannerPreviewImg');
                    break;
                case 'modal':
                    fileInput = document.getElementById('modalFileInput');
                    preview = document.getElementById('modalPreview');
                    previewImg = document.getElementById('modalPreviewImg');
                    break;
            }
            
            if (fileInput) fileInput.value = '';
            if (preview) preview.style.display = 'none';
            if (previewImg) previewImg.src = '';
            
            if (type === 'modal') {
                document.getElementById('saveUploadBtn').disabled = true;
            }
        }

        function openUploadModal(type) {
            currentUploadType = type;
            const modal = document.getElementById('uploadModal');
            const title = document.getElementById('uploadModalTitle');
            const hint = document.getElementById('modalUploadHint');
            
            if (type === 'avatar') {
                title.textContent = 'Upload Avatar';
                hint.textContent = 'PNG, JPG, GIF up to 5MB';
            } else {
                title.textContent = 'Upload Banner';
                hint.textContent = 'PNG, JPG up to 10MB';
            }
            
            clearPreview('modal');
            modal.classList.remove('d-none');
        }

        function processImageUpload(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress image if needed
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 1000px for avatars, 2000px for banners)
                    const maxSize = currentUploadType === 'avatar' ? 1000 : 2000;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        } else {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedData = canvas.toDataURL('image/jpeg', 0.8);
                    callback(compressedData);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveUploadedImage() {
            const fileInput = document.getElementById('modalFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('error', 'Error', 'Please select an image first');
                return;
            }
            
            processImageUpload(file, (imageData) => {
                if (currentUploadType === 'avatar') {
                    currentUser.avatar = imageData;
                    updateAvatar(imageData);
                    showNotification('success', 'Success', 'Avatar updated successfully');
                } else {
                    currentUser.banner = imageData;
                    updateBanner(imageData);
                    showNotification('success', 'Success', 'Banner updated successfully');
                }
                
                allUsers[currentUser.username] = currentUser;
                saveData();
                closeModal('uploadModal');
            });
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            if (!currentUser) return;
            
            // Update header
            document.getElementById('headerUsername').innerHTML = `
                <i class="fas fa-user"></i>
                @${currentUser.username}
            `;
            
            // Update profile
            document.getElementById('userDisplayName').textContent = currentUser.displayName;
            document.getElementById('userUsername').textContent = `@${currentUser.username}`;
            document.getElementById('userBio').textContent = currentUser.bio || 'No bio yet';
            
            updateAvatar(currentUser.avatar);
            updateBanner(currentUser.banner);
            updateStatus(currentUser.status);
            
            // Update stats
            updateStats();
            
            // Load content
            loadFriends();
            loadFriendRequests();
            loadConversations();
            loadActivity();
            updateNotificationBadge();
            
            // Show home page
            showPage('home');
        }

        function updateAvatar(imageData) {
            const avatar = document.getElementById('userAvatar');
            avatar.style.backgroundImage = `url(${imageData})`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
        }

        function updateBanner(imageData) {
            const banner = document.getElementById('userBanner');
            if (imageData) {
                banner.style.backgroundImage = `url(${imageData})`;
            }
        }

        function updateStatus(status) {
            const statusDot = document.getElementById('userStatus');
            statusDot.style.background = status === 'online' ? 'var(--online)' : 
                                         status === 'away' ? 'var(--away)' : 'var(--offline)';
        }

        function updateStats() {
            const userFriends = friends[currentUser.username] || [];
            const userRequests = friendRequests[currentUser.username] || [];
            
            // Count online friends
            let onlineCount = 0;
            userFriends.forEach(friendUsername => {
                const friend = allUsers[friendUsername];
                if (friend && friend.status === 'online') onlineCount++;
            });
            
            // Count messages
            let messageCount = 0;
            Object.keys(messages).forEach(key => {
                if (key.includes(currentUser.username)) {
                    messageCount += messages[key].length;
                }
            });
            
            // Update DOM
            document.getElementById('statFriends').textContent = userFriends.length;
            document.getElementById('statOnline').textContent = onlineCount;
            document.getElementById('statMessages').textContent = messageCount;
            document.getElementById('statRequests').textContent = userRequests.length;
        }

        // ==================== FRIEND SYSTEM ====================
        function loadFriends() {
            const userFriends = friends[currentUser.username] || [];
            const friendsGrid = document.getElementById('friendsGrid');
            const onlineGrid = document.getElementById('onlineFriendsGrid');
            
            // Clear grids
            friendsGrid.innerHTML = '';
            onlineGrid.innerHTML = '';
            
            if (userFriends.length === 0) {
                friendsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 64px 32px; text-align: center;">
                        <div class="empty-icon">üë•</div>
                        <div class="empty-title">No Friends Yet</div>
                        <div class="empty-description">Add friends to start connecting</div>
                        <button class="btn btn-primary mt-3" onclick="showAddFriendModal()">Add Your First Friend</button>
                    </div>
                `;
                return;
            }
            
            let onlineHTML = '';
            let allHTML = '';
            
            userFriends.forEach(friendUsername => {
                const friend = allUsers[friendUsername];
                if (!friend) return;
                
                const friendCard = `
                    <div class="friend-card" onclick="startChat('${friendUsername}')">
                        <div class="friend-avatar" style="background-image: url(${friend.avatar})">
                            <div class="friend-status ${friend.status}"></div>
                        </div>
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-username">@${friend.username}</div>
                        <div class="friend-actions mt-2">
                            <button class="btn btn-small btn-primary flex-1" onclick="event.stopPropagation(); startChat('${friendUsername}')">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="btn btn-small btn-danger flex-1" onclick="event.stopPropagation(); removeFriend('${friend.username}')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                allHTML += friendCard;
                
                if (friend.status === 'online') {
                    onlineHTML += friendCard;
                }
            });
            
            friendsGrid.innerHTML = allHTML;
            onlineGrid.innerHTML = onlineHTML || `
                <div style="grid-column: 1/-1; padding: 32px; text-align: center; color: var(--text-secondary);">
                    No friends online right now
                </div>
            `;
        }

        function loadFriendRequests() {
            const requests = friendRequests[currentUser.username] || [];
            const container = document.getElementById('friendRequestsList');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">üë§</div>
                        <div class="empty-title">No Friend Requests</div>
                        <div class="empty-description">When someone sends you a request, it will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            requests.forEach((request, index) => {
                const sender = allUsers[request.from];
                if (!sender) return;
                
                const timeAgo = getTimeAgo(request.timestamp);
                html += `
                    <div class="conversation">
                        <div class="conversation-avatar" style="background-image: url(${sender.avatar})"></div>
                        <div class="conversation-info">
                            <div class="conversation-name">${sender.displayName}</div>
                            <div class="conversation-preview">@${sender.username}</div>
                            <div class="conversation-time">${timeAgo}</div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-success btn-icon" onclick="acceptFriendRequest(${index})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="declineFriendRequest(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAddFriendModal() {
            const modal = document.getElementById('addFriendModal');
            const input = document.getElementById('addFriendInput');
            input.value = '';
            input.focus();
            document.getElementById('friendSearchResults').innerHTML = `
                <div class="empty-state" style="padding: 32px 0;">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-title">Search for users</div>
                    <div class="empty-description">Enter a username above to search</div>
                </div>
            `;
            document.getElementById('sendRequestBtn').disabled = true;
            modal.classList.remove('d-none');
        }

        function searchUsers(query) {
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                const results = Object.values(allUsers).filter(user => 
                    user.username !== currentUser.username &&
                    (user.username.toLowerCase().includes(query.toLowerCase()) || 
                     user.displayName.toLowerCase().includes(query.toLowerCase()))
                );
                
                const container = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div class="empty-title">No Users Found</div>
                            <div class="empty-description">Try a different search term</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="friends-grid">';
                results.forEach(user => {
                    const isFriend = friends[currentUser.username]?.includes(user.username);
                    const hasRequest = friendRequests[user.username]?.some(req => req.from === currentUser.username);
                    
                    html += `
                        <div class="friend-card">
                            <div class="friend-avatar" style="background-image: url(${user.avatar})">
                                <div class="friend-status ${user.status}"></div>
                            </div>
                            <div class="friend-name">${user.displayName}</div>
                            <div class="friend-username">@${user.username}</div>
                            <div class="friend-actions mt-2">
                                ${isFriend ? 
                                    `<button class="btn btn-small flex-1" disabled>
                                        <i class="fas fa-check"></i> Friends
                                    </button>` :
                                    hasRequest ?
                                    `<button class="btn btn-small flex-1" disabled>
                                        <i class="fas fa-clock"></i> Request Sent
                                    </button>` :
                                    `<button class="btn btn-small btn-primary flex-1" onclick="sendFriendRequestFromSearch('${user.username}')">
                                        <i class="fas fa-user-plus"></i> Add Friend
                                    </button>`
                                }
                                <button class="btn btn-small flex-1" onclick="startChat('${user.username}')">
                                    <i class="fas fa-comment"></i> Message
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            }, 300);
        }

        function searchUserForModal(username) {
            const resultsDiv = document.getElementById('friendSearchResults');
            
            if (!username) {
                resultsDiv.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Search for users</div>
                        <div class="empty-description">Enter a username above to search</div>
                    </div>
                `;
                document.getElementById('sendRequestBtn').disabled = true;
                return;
            }
            
            const user = allUsers[username.toLowerCase()];
            
            if (!user) {
                resultsDiv.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">User Not Found</div>
                        <div class="empty-description">Make sure you entered the exact username</div>
                    </div>
                `;
                document.getElementById('sendRequestBtn').disabled = true;
                return;
            }
            
            if (user.username === currentUser.username) {
                resultsDiv.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">üë§</div>
                        <div class="empty-title">That's You!</div>
                        <div class="empty-description">You can't add yourself as a friend</div>
                    </div>
                `;
                document.getElementById('sendRequestBtn').disabled = true;
                return;
            }
            
            if (friends[currentUser.username]?.includes(user.username)) {
                resultsDiv.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-title">Already Friends</div>
                        <div class="empty-description">You are already friends with this user</div>
                    </div>
                `;
                document.getElementById('sendRequestBtn').disabled = true;
                return;
            }
            
            const hasRequest = friendRequests[user.username]?.some(req => req.from === currentUser.username);
            if (hasRequest) {
                resultsDiv.innerHTML = `
                    <div class="empty-state" style="padding: 32px 0;">
                        <div class="empty-icon">‚è≥</div>
                        <div class="empty-title">Request Already Sent</div>
                        <div class="empty-description">Waiting for ${user.displayName} to accept</div>
                    </div>
                `;
                document.getElementById('sendRequestBtn').disabled = true;
                return;
            }
            
            resultsDiv.innerHTML = `
                <div class="friend-card">
                    <div class="friend-avatar" style="background-image: url(${user.avatar})">
                        <div class="friend-status ${user.status}"></div>
                    </div>
                    <div class="friend-name">${user.displayName}</div>
                    <div class="friend-username">@${user.username}</div>
                    <div class="profile-bio mt-2" style="text-align: center; font-size: 14px;">${user.bio || 'No bio yet'}</div>
                </div>
            `;
            
            document.getElementById('sendRequestBtn').disabled = false;
        }

        function sendFriendRequestFromModal() {
            const username = document.getElementById('addFriendInput').value.trim().toLowerCase();
            
            if (!username) {
                showNotification('error', 'Error', 'Please enter a username');
                return;
            }
            
            sendFriendRequest(username);
            closeModal('addFriendModal');
        }

        function sendFriendRequestFromSearch(username) {
            sendFriendRequest(username);
            showNotification('success', 'Request Sent', `Friend request sent to @${username}`);
        }

        function sendFriendRequest(targetUsername) {
            const targetUser = allUsers[targetUsername];
            if (!targetUser) {
                showNotification('error', 'Error', 'User not found');
                return;
            }
            
            if (!friendRequests[targetUsername]) {
                friendRequests[targetUsername] = [];
            }
            
            friendRequests[targetUsername].push({
                from: currentUser.username,
                timestamp: new Date().toISOString()
            });
            
            // Add notification for target user
            addNotification('info', 'New Friend Request', 
                `${currentUser.displayName} (@${currentUser.username}) sent you a friend request`);
            
            saveData();
            loadFriendRequests();
            updateStats();
        }

        function acceptFriendRequest(index) {
            const request = friendRequests[currentUser.username][index];
            const senderUsername = request.from;
            
            // Add to friends lists
            if (!friends[currentUser.username]) friends[currentUser.username] = [];
            if (!friends[senderUsername]) friends[senderUsername] = [];
            
            if (!friends[currentUser.username].includes(senderUsername)) {
                friends[currentUser.username].push(senderUsername);
            }
            if (!friends[senderUsername].includes(currentUser.username)) {
                friends[senderUsername].push(currentUser.username);
            }
            
            // Remove request
            friendRequests[currentUser.username].splice(index, 1);
            
            // Add notification for sender
            addNotification('success', 'Friend Request Accepted',
                `${currentUser.displayName} (@${currentUser.username}) accepted your friend request`);
            
            saveData();
            loadFriends();
            loadFriendRequests();
            updateStats();
            showNotification('success', 'Friend Added', `You are now friends with @${senderUsername}`);
        }

        function declineFriendRequest(index) {
            const request = friendRequests[currentUser.username][index];
            const senderUsername = request.from;
            
            friendRequests[currentUser.username].splice(index, 1);
            saveData();
            loadFriendRequests();
            updateStats();
            showNotification('info', 'Request Declined', `Friend request from @${senderUsername} declined`);
        }

        function removeFriend(friendUsername) {
            if (!confirm(`Remove ${friendUsername} from your friends?`)) return;
            
            // Remove from both sides
            const userIndex = friends[currentUser.username]?.indexOf(friendUsername);
            const friendIndex = friends[friendUsername]?.indexOf(currentUser.username);
            
            if (userIndex > -1) friends[currentUser.username].splice(userIndex, 1);
            if (friendIndex > -1) friends[friendUsername].splice(friendIndex, 1);
            
            // Clear conversation if active
            if (currentChat === friendUsername) {
                currentChat = null;
                document.getElementById('chatInputArea').classList.add('d-none');
                document.getElementById('chatHeaderInfo').innerHTML = `
                    <div class="empty-state" style="padding: 0;">
                        <div class="empty-icon">üí¨</div>
                        <div class="empty-title">Select a conversation</div>
                        <div class="empty-description">Choose a friend to start messaging</div>
                    </div>
                `;
                document.getElementById('chatMessages').innerHTML = '';
            }
            
            saveData();
            loadFriends();
            updateStats();
            loadConversations();
            showNotification('info', 'Friend Removed', `Removed @${friendUsername} from friends`);
        }

        // ==================== MESSAGING SYSTEM ====================
        function loadConversations() {
            const userFriends = friends[currentUser.username] || [];
            const container = document.getElementById('conversationsList');
            
            if (userFriends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <div class="empty-title">No Conversations</div>
                        <div class="empty-description">Add friends to start messaging</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userFriends.forEach(friendUsername => {
                const friend = allUsers[friendUsername];
                if (!friend) return;
                
                const chatId = getChatId(currentUser.username, friendUsername);
                const chatMessages = messages[chatId] || [];
                const lastMessage = chatMessages[chatMessages.length - 1];
                const unreadCount = chatMessages.filter(m => 
                    m.sender === friendUsername && !m.read
                ).length;
                
                html += `
                    <div class="conversation ${currentChat === friendUsername ? 'active' : ''}" 
                         onclick="startChat('${friendUsername}')">
                        <div class="conversation-avatar" style="background-image: url(${friend.avatar})">
                            ${unreadCount > 0 ? `<span class="notification-count">${unreadCount}</span>` : ''}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${friend.displayName}</div>
                            <div class="conversation-preview">
                                ${lastMessage ? (lastMessage.sender === currentUser.username ? 'You: ' : '') + 
                                  lastMessage.text.substring(0, 30) + (lastMessage.text.length > 30 ? '...' : '') : 'No messages yet'}
                            </div>
                            ${lastMessage ? 
                                `<div class="conversation-time">${getTimeAgo(lastMessage.timestamp)}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function startChat(friendUsername) {
            currentChat = friendUsername;
            const friend = allUsers[friendUsername];
            
            // Update chat header
            document.getElementById('chatHeaderInfo').innerHTML = `
                <div class="d-flex align-center gap-3">
                    <div class="conversation-avatar" style="background-image: url(${friend.avatar})"></div>
                    <div>
                        <div class="chat-username">${friend.displayName}</div>
                        <div class="chat-status">
                            <div class="chat-status-dot" style="background: ${friend.status === 'online' ? 'var(--online)' : 
                                                                              friend.status === 'away' ? 'var(--away)' : 'var(--offline)'}"></div>
                            <span>${friend.status}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Show input area
            document.getElementById('chatInputArea').classList.remove('d-none');
            document.getElementById('messageInput').focus();
            
            // Load messages
            loadChatMessages(friendUsername);
            
            // Update conversations list
            loadConversations();
            
            // Navigate to messages page
            showPage('messages');
        }

        function loadChatMessages(friendUsername) {
            const container = document.getElementById('chatMessages');
            const chatId = getChatId(currentUser.username, friendUsername);
            const chatMessages = messages[chatId] || [];
            
            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 64px 32px;">
                        <div class="empty-icon">üí¨</div>
                        <div class="empty-title">No messages yet</div>
                        <div class="empty-description">Send a message to start the conversation!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let lastSender = null;
            let lastDate = null;
            
            chatMessages.forEach((msg, index) => {
                const isCurrentUser = msg.sender === currentUser.username;
                const sender = allUsers[msg.sender];
                const msgDate = new Date(msg.timestamp);
                const dateStr = msgDate.toLocaleDateString();
                
                // Add date separator if date changed
                if (dateStr !== lastDate) {
                    html += `
                        <div style="text-align: center; margin: 20px 0;">
                            <span style="background: var(--bg-tertiary); padding: 4px 12px; border-radius: 12px; font-size: 12px; color: var(--text-muted);">
                                ${dateStr}
                            </span>
                        </div>
                    `;
                    lastDate = dateStr;
                }
                
                // Add sender name if changed
                if (msg.sender !== lastSender && !isCurrentUser) {
                    html += `
                        <div style="font-size: 12px; color: var(--text-secondary); margin-left: 56px; margin-bottom: 4px;">
                            ${sender?.displayName || msg.sender}
                        </div>
                    `;
                }
                
                html += `
                    <div class="message ${isCurrentUser ? 'sent' : 'received'}">
                        ${!isCurrentUser ? `
                            <div class="message-avatar" style="background-image: url(${sender?.avatar})"></div>
                        ` : ''}
                        <div class="message-content">
                            <div class="message-text">${msg.text}</div>
                            <div class="message-time">${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        ${isCurrentUser ? `
                            <div class="message-avatar" style="background-image: url(${currentUser.avatar})"></div>
                        ` : ''}
                    </div>
                `;
                
                lastSender = msg.sender;
                
                // Mark as read if not current user's message
                if (!isCurrentUser && !msg.read) {
                    msg.read = true;
                }
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
            saveData();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            const chatId = getChatId(currentUser.username, currentChat);
            if (!messages[chatId]) messages[chatId] = [];
            
            const message = {
                sender: currentUser.username,
                text: text,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            messages[chatId].push(message);
            
            // Add notification for recipient if offline
            const friend = allUsers[currentChat];
            if (friend.status !== 'online') {
                addNotification('info', 'New Message',
                    `${currentUser.displayName} sent you a message`);
            }
            
            saveData();
            input.value = '';
            loadChatMessages(currentChat);
            loadConversations();
            updateStats();
        }

        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        // ==================== ACTIVITY FEED ====================
        function loadActivity() {
            const container = document.getElementById('activityList');
            const userFriends = friends[currentUser.username] || [];
            
            if (userFriends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-title">No Activity Yet</div>
                        <div class="empty-description">Your recent activity will appear here</div>
                    </div>
                `;
                return;
            }
            
            let activities = [];
            
            // Get recent messages
            Object.keys(messages).forEach(chatId => {
                if (chatId.includes(currentUser.username)) {
                    const chatMessages = messages[chatId];
                    const lastMessage = chatMessages[chatMessages.length - 1];
                    if (lastMessage) {
                        const otherUser = chatId.replace(currentUser.username, '').replace('_', '');
                        const user = allUsers[otherUser];
                        if (user) {
                            activities.push({
                                type: 'message',
                                user: user,
                                text: lastMessage.text,
                                timestamp: lastMessage.timestamp,
                                preview: lastMessage.sender === currentUser.username ? 
                                    `You: ${lastMessage.text.substring(0, 30)}${lastMessage.text.length > 30 ? '...' : ''}` :
                                    `${user.displayName}: ${lastMessage.text.substring(0, 30)}${lastMessage.text.length > 30 ? '...' : ''}`
                            });
                        }
                    }
                }
            });
            
            // Get friend requests
            const userRequests = friendRequests[currentUser.username] || [];
            userRequests.forEach(request => {
                const sender = allUsers[request.from];
                if (sender) {
                    activities.push({
                        type: 'request',
                        user: sender,
                        text: 'sent you a friend request',
                        timestamp: request.timestamp,
                        preview: `${sender.displayName} sent a friend request`
                    });
                }
            });
            
            // Sort by timestamp
            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-title">No Activity Yet</div>
                        <div class="empty-description">Your recent activity will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            activities.slice(0, 10).forEach(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                html += `
                    <div class="conversation" onclick="${activity.type === 'request' ? 'showPage(\'friends\')' : `startChat('${activity.user.username}')`}">
                        <div class="conversation-avatar" style="background-image: url(${activity.user.avatar})"></div>
                        <div class="conversation-info">
                            <div class="conversation-name">${activity.type === 'message' ? 'New Message' : 'Friend Request'}</div>
                            <div class="conversation-preview">${activity.preview}</div>
                            <div class="conversation-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== PROFILE MANAGEMENT ====================
        function editProfile() {
            document.getElementById('editDisplayName').value = currentUser.displayName;
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editStatus').value = currentUser.status;
            
            // Clear previews
            clearPreview('editAvatar');
            clearPreview('editBanner');
            
            document.getElementById('editProfileModal').classList.remove('d-none');
        }

        function saveProfile() {
            const newDisplayName = document.getElementById('editDisplayName').value.trim();
            const newBio = document.getElementById('editBio').value.trim();
            const newStatus = document.getElementById('editStatus').value;
            
            if (!newDisplayName) {
                showNotification('error', 'Error', 'Display name cannot be empty');
                return;
            }
            
            currentUser.displayName = newDisplayName;
            currentUser.bio = newBio;
            currentUser.status = newStatus;
            
            // Handle avatar upload
            const avatarFile = document.getElementById('editAvatarFile').files[0];
            const bannerFile = document.getElementById('editBannerFile').files[0];
            
            if (avatarFile) {
                processImageUpload(avatarFile, (avatarData) => {
                    currentUser.avatar = avatarData;
                    if (bannerFile) {
                        processImageUpload(bannerFile, (bannerData) => {
                            currentUser.banner = bannerData;
                            finalizeProfileSave();
                        });
                    } else {
                        finalizeProfileSave();
                    }
                });
            } else if (bannerFile) {
                processImageUpload(bannerFile, (bannerData) => {
                    currentUser.banner = bannerData;
                    finalizeProfileSave();
                });
            } else {
                finalizeProfileSave();
            }
        }

        function finalizeProfileSave() {
            allUsers[currentUser.username] = currentUser;
            saveData();
            
            updateUI();
            closeModal('editProfileModal');
            showNotification('success', 'Success', 'Profile updated successfully');
        }

        function changeStatus() {
            document.getElementById('statusModal').classList.remove('d-none');
        }

        function setStatus(status) {
            currentUser.status = status;
            currentUser.lastSeen = new Date().toISOString();
            allUsers[currentUser.username] = currentUser;
            saveData();
            
            updateStatus(status);
            closeModal('statusModal');
            showNotification('success', 'Status Updated', `You are now ${status}`);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diff = now - past;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return past.toLocaleDateString();
        }

        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('d-none');
            });
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.remove('d-none');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageName) {
                    link.classList.add('active');
                }
            });
            
            // Load page-specific data
            if (pageName === 'friends') {
                loadFriends();
            } else if (pageName === 'search') {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').innerHTML = '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('d-none');
        }

        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            const span = button.querySelector('span');
            const loading = button.querySelector('.loading');
            
            if (span) span.classList.add('d-none');
            if (loading) loading.classList.remove('d-none');
            button.disabled = true;
        }

        function hideLoading(buttonId) {
            const button = document.getElementById(buttonId);
            const span = button.querySelector('span');
            const loading = button.querySelector('.loading');
            
            if (span) span.classList.remove('d-none');
            if (loading) loading.classList.add('d-none');
            button.disabled = false;
        }

        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                if (currentUser) {
                    currentUser.status = 'offline';
                    currentUser.lastSeen = new Date().toISOString();
                    allUsers[currentUser.username] = currentUser;
                    saveData();
                }
                
                localStorage.removeItem(STORAGE.CURRENT);
                location.reload();
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data
            loadData();
            
            // Setup auth
            setupAuth();
            
            // Setup event listeners
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage(this.dataset.page);
                });
            });
            
            // Search input handler
            document.getElementById('addFriendInput').addEventListener('input', function() {
                searchUserForModal(this.value.trim().toLowerCase());
            });
            
            // Message input enter key
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Button listeners
            document.getElementById('notificationsBtn').onclick = function() {
                loadNotifications();
                document.getElementById('notificationsModal').classList.remove('d-none');
            };
            
            document.getElementById('logoutBtn').onclick = logout;
            
            // Check if user is logged in
            const currentUsername = localStorage.getItem(STORAGE.CURRENT);
            if (currentUsername && allUsers[currentUsername]) {
                currentUser = allUsers[currentUsername];
                currentUser.status = 'online';
                currentUser.lastSeen = new Date().toISOString();
                allUsers[currentUsername] = currentUser;
                saveData();
                
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainApp').classList.remove('d-none');
                updateUI();
            }
            
            // Auto-save every minute
            setInterval(() => {
                if (currentUser) {
                    saveData();
                }
            }, 60000);
            
            // Update online status periodically
            setInterval(() => {
                if (currentUser && currentUser.status === 'online') {
                    currentUser.lastSeen = new Date().toISOString();
                    allUsers[currentUser.username] = currentUser;
                }
            }, 30000);
        });
    </script>
</body>
</html>
